<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memento - Secure Decryption</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>
<body class="dark-theme">
    <div class="container">
        <header>
            <h1 class="glitch">RECOVER LEGACY</h1>
            <p>Enter the blockchain signature and password to unlock.</p>
        </header>

        <div class="card" style="max-width: 500px; margin: 2rem auto;">
            <div class="form-group">
                <label>Transaction Signature (TX ID)</label>
                <input type="text" id="txId" placeholder="Solana Transaction ID" required>
            </div>
            <div class="form-group">
                <label>Encryption Password</label>
                <input type="password" id="decryptPassword" placeholder="Message Password" required>
            </div>
            <button class="btn btn-primary" id="decryptBtn" style="width: 100%">UNLOCK MESSAGE</button>
            <div id="resultArea" class="hidden" style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <h3>DECRYPTED MESSAGE</h3>
                <div id="decryptedText" style="white-space: pre-wrap; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 4px;"></div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 2rem;">
            <a href="index.html" class="btn">Back to Login</a>
        </div>
    </div>

    <script>
        document.getElementById('decryptBtn').onclick = async () => {
            const txId = document.getElementById('txId').value;
            const password = document.getElementById('decryptPassword').value;
            const btn = document.getElementById('decryptBtn');
            const resultArea = document.getElementById('resultArea');
            const decryptedText = document.getElementById('decryptedText');

            if (!txId || !password) return alert("Missing fields");

            btn.disabled = true;
            btn.textContent = "SEARCHING BLOCKCHAIN...";

            try {
                // Fetch from Local API first (it has the cache)
                const resp = await fetch(`http://localhost:5000/api/blockchain/retrieve/${txId}`);
                if (!resp.ok) throw new Error("Could not find message data");
                
                const data = await resp.json();
                const encrypted = data.encrypted_content;

                // Decrypt
                const bytes = CryptoJS.AES.decrypt(encrypted, password);
                const originalText = bytes.toString(CryptoJS.enc.Utf8);

                if (!originalText) {
                    alert("Wrong password or corrupted data.");
                } else {
                    resultArea.classList.remove('hidden');
                    decryptedText.textContent = originalText;
                }
            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "UNLOCK MESSAGE";
            }
        };
    </script>
</body>
</html>
